# --- Query Metadata ---
# Human-readable name for the query. Will be displayed as the title.
name: "User Logon Details (Time, Type, Location, Last Password Change)"

# Description of what the query does and its purpose.
description: "This query will output a table including recent user logons with context information: 
- Timestamp
- UserName
- SID
- LogonType
- UserIsAdmin (Y/N)
- PasswordLastSet
- Location"

# The author or team that created the query.
author: CrowdStrike

# The required log sources to run this query successfully in Next-Gen SIEM.
# This will be displayed in the UI to inform the user.
log_sources:
  - Endpoint

# The CrowdStrike modules required to run this query.
cs_required_modules:
  - Insight

# Tags for filtering and categorization.
# Include relevant techniques, tactics, or platforms.
tags:
  - Hunting
  - Monitoring

# --- Query Content ---
# The actual CrowdStrike Query Language (CQL) code.
# Using the YAML block scalar `|` allows for multi-line strings.
cql: |
  #event_simpleName=UserLogon UserSid=S-1-5-21-*
  | in(LogonType, values=["2","10"])
  | ipLocation(aip)
  | $falcon/helper:enrich(field=UserIsAdmin)
  | $falcon/helper:enrich(field=UserLogon)
  | PasswordLastSet := PasswordLastSet*1000
  | ContextTimeStamp := ContextTimeStamp*1000
  | PasswordLastSet := formatTime("%Y-%m-%d %H:%M:%S", field=PasswordLastSet, locale=en_US, timezone=Z)
  | ContextTimeStamp := formatTime("%Y-%m-%d %H:%M:%S", field=ContextTimeStamp, locale=en_US, timezone=Z)
  | table(["ContextTimeStamp", "aid", "UserName", "UserSid", "LogonType", "UserIsAdmin", "PasswordLastSet", "aip.city", "aip.state", "aip.country"])

